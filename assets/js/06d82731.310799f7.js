"use strict";(self.webpackChunkidearium_lib_docs=self.webpackChunkidearium_lib_docs||[]).push([[37],{3905:function(e,t,a){a.d(t,{Zo:function(){return u},kt:function(){return f}});var s=a(7294);function r(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function n(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);t&&(s=s.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,s)}return a}function l(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?n(Object(a),!0).forEach((function(t){r(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):n(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function o(e,t){if(null==e)return{};var a,s,r=function(e,t){if(null==e)return{};var a,s,r={},n=Object.keys(e);for(s=0;s<n.length;s++)a=n[s],t.indexOf(a)>=0||(r[a]=e[a]);return r}(e,t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);for(s=0;s<n.length;s++)a=n[s],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(r[a]=e[a])}return r}var i=s.createContext({}),c=function(e){var t=s.useContext(i),a=t;return e&&(a="function"==typeof e?e(t):l(l({},t),e)),a},u=function(e){var t=c(e.components);return s.createElement(i.Provider,{value:t},e.children)},p="mdxType",d={inlineCode:"code",wrapper:function(e){var t=e.children;return s.createElement(s.Fragment,{},t)}},m=s.forwardRef((function(e,t){var a=e.components,r=e.mdxType,n=e.originalType,i=e.parentName,u=o(e,["components","mdxType","originalType","parentName"]),p=c(a),m=r,f=p["".concat(i,".").concat(m)]||p[m]||d[m]||n;return a?s.createElement(f,l(l({ref:t},u),{},{components:a})):s.createElement(f,l({ref:t},u))}));function f(e,t){var a=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var n=a.length,l=new Array(n);l[0]=m;var o={};for(var i in t)hasOwnProperty.call(t,i)&&(o[i]=t[i]);o.originalType=e,o[p]="string"==typeof e?e:r,l[1]=o;for(var c=2;c<n;c++)l[c]=a[c];return s.createElement.apply(null,l)}return s.createElement.apply(null,a)}m.displayName="MDXCreateElement"},2372:function(e,t,a){a.r(t),a.d(t,{assets:function(){return i},contentTitle:function(){return l},default:function(){return d},frontMatter:function(){return n},metadata:function(){return o},toc:function(){return c}});var s=a(3117),r=(a(7294),a(3905));const n={id:"cloudflare-queues",title:"@idearium/cloudflare-queues"},l=void 0,o={unversionedId:"cloudflare-queues",id:"cloudflare-queues",title:"@idearium/cloudflare-queues",description:"Safely process Cloudflare Queues batches and messages.",source:"@site/docs/cloudflare-queues.md",sourceDirName:".",slug:"/cloudflare-queues",permalink:"/idearium-lib/docs/cloudflare-queues",draft:!1,editUrl:"https://github.com/idearium/idearium-lib/tree/master/docusaurus/docs/cloudflare-queues.md",tags:[],version:"current",frontMatter:{id:"cloudflare-queues",title:"@idearium/cloudflare-queues"},sidebar:"sidebar",previous:{title:"@idearium/certs",permalink:"/idearium-lib/docs/certs"},next:{title:"@idearium/cookie",permalink:"/idearium-lib/docs/cookie"}},i={},c=[{value:"Installation",id:"installation",level:2},{value:"Beta installation",id:"beta-installation",level:3},{value:"Usage",id:"usage",level:2},{value:"Process batches",id:"process-batches",level:3},{value:"Process messages",id:"process-messages",level:3},{value:"Functions",id:"functions",level:2},{value:"safeBatchProcess",id:"safebatchprocess",level:3},{value:"safeMessageProcess",id:"safemessageprocess",level:3}],u={toc:c},p="wrapper";function d(e){let{components:t,...a}=e;return(0,r.kt)(p,(0,s.Z)({},u,a,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("p",null,"Safely process Cloudflare Queues batches and messages."),(0,r.kt)("h2",{id:"installation"},"Installation"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"$ yarn add -E @idearium/cloudflare-queues\n")),(0,r.kt)("h3",{id:"beta-installation"},"Beta installation"),(0,r.kt)("p",null,"If you need to install a beta version, you can:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"$ yarn add -E @idearium/cloudflare-queues@beta\n")),(0,r.kt)("h2",{id:"usage"},"Usage"),(0,r.kt)("p",null,"Use ",(0,r.kt)("inlineCode",{parentName:"p"},"@idearium/cloudflare-queues")," to safely process both batches and individual messages."),(0,r.kt)("h3",{id:"process-batches"},"Process batches"),(0,r.kt)("p",null,"This shows an example of a Cloudflare Worker that processes the entire batch of messages at once."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"import { safeBatchProcess } from '@idearium/cloudflare-queues';\n\nexport default {\n    async queue(messageBatch, env) {\n        await safeBatchProcess({\n            process: async (batch) => {\n                await Promise.all(\n                    batch.messages.map(({ body }) => Promise.resolve(body))\n                );\n            },\n            batch: messageBatch,\n        });\n    },\n};\n")),(0,r.kt)("h3",{id:"process-messages"},"Process messages"),(0,r.kt)("p",null,"This shows an example of a Cloudflare Worker that hands off to a function that processes each message individually."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"// lib/consume.js\nimport { safeMessageProcess } from '@idearium/cloudflare-queues';\n\nexport const consume = async (queueMessage) =>\n    safeMessageProcess({\n        message: queueMessage,\n        process: async (message) => Promise.resolve(message.body),\n    });\n")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"// worker.js\nimport { consume } from './lib/consume.js';\n\nexport default {\n    async queue(batch, env) {\n        await Promise.allSettled(batch.messages.map(consume));\n    },\n};\n")),(0,r.kt)("h2",{id:"functions"},"Functions"),(0,r.kt)("p",null,"You can process entire batches of messages or each individual message. If you process an entire batch and they all fail, the entire batch will be retried. If you process each message individually, only those messages that fail will be retried. Read more about ",(0,r.kt)("a",{parentName:"p",href:"https://developers.cloudflare.com/queues/learning/batching-retries/#explicit-acknowledgement"},"explicit acknowledgement")," and ",(0,r.kt)("a",{parentName:"p",href:"https://developers.cloudflare.com/queues/learning/batching-retries/#retries"},"retries"),"."),(0,r.kt)("h3",{id:"safebatchprocess"},"safeBatchProcess"),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"safeBatchProcess")," expects an object with the following properties:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"process"),": A function that processes the batch."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"batch"),": The batch to process.")),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"safeBatchProcess")," will call the ",(0,r.kt)("inlineCode",{parentName:"p"},"process")," function provided to it and pass the batch as the only argument."),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"safeBatchProcess")," returns a promise that resolves when the batch has been processed. It will also call ",(0,r.kt)("a",{parentName:"p",href:"https://developers.cloudflare.com/queues/platform/javascript-apis/#messagebatch"},(0,r.kt)("inlineCode",{parentName:"a"},"batch.ackAll()")," to acknowledge the batch"),"."),(0,r.kt)("p",null,"If the batch cannot be processed, the promise will reject with an error. It will also call ",(0,r.kt)("a",{parentName:"p",href:"https://developers.cloudflare.com/queues/platform/javascript-apis/#messagebatch"},(0,r.kt)("inlineCode",{parentName:"a"},"batch.retryAll()")," to reject the batch")," so that all messages in the batch will be retried."),(0,r.kt)("h3",{id:"safemessageprocess"},"safeMessageProcess"),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"safeMessageProcess")," expects an object with the following properties:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"process"),": A function that processes the message."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"message"),": The message to process.")),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"safeMessageProcess")," will call the ",(0,r.kt)("inlineCode",{parentName:"p"},"process")," function provided to it and pass the message as the only argument."),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"safeMessageProcess")," returns a promise that resolves when the message has been processed. It will also call ",(0,r.kt)("a",{parentName:"p",href:"https://developers.cloudflare.com/queues/platform/javascript-apis/#message"},(0,r.kt)("inlineCode",{parentName:"a"},"message.ack()")," to acknowledge the message"),"."),(0,r.kt)("p",null,"If the message cannot be processed, the promise will reject with an error. It will also call ",(0,r.kt)("a",{parentName:"p",href:"https://developers.cloudflare.com/queues/platform/javascript-apis/#message"},(0,r.kt)("inlineCode",{parentName:"a"},"message.retry()")," to reject the message")," so that it will be retried."))}d.isMDXComponent=!0}}]);